# Demo setup for [vite-envs](https://github.com/garronej/vite-envs)

This is a "hello world" app to demonstrate how to set up [vite-envs](https://github.com/garronej/vite-envs)
in a `Vite`/`TypeScript`/`Docker` WebApp.

## Try it

`.env`
```.env
# The .env file is where you declare your variables
# This is the sources of trush for the type definitions generated by `cra-envs`.
# You can set default values or leave it blanck.  
TITLE=Default title
CUSTOM_META=
```

`.env.local` (Not tracked by Git)
```.env
TITLE=Custom title
CUSTOM_META='{ foo: "value1", bar: "value2", baz: "value3" }'
```

`src/main.tsx`
```ts
console.log(`The title of the page is ${import.meta.env.TITLE}`);
```

`index.html`
```html
<!doctype html>
<html lang="en">
  <head>
    <!-- ... -->

    <title>%TITLE%</title>

    <!-- JSON5 (https://json5.org/) is made available by vite-envs, 
         JSON5 is an extension to JSON that aims to be easier to write and 
         maintain by hand (e.g. for config files). -->
    <% const obj = JSON5.parse(import.meta.env.CUSTOM_META); %>
    <% for (const [key, value] of Object.entries(obj)) { %>
      <meta name="<%= key %>" content="<%= value %>" />
    <% } %>
</head>
```

As you've noticed, beside the fact that you can now drop the `VITE_`
prefix and that you can have EJS in your `index.html` things work the
way you are already used to.  

Now, however you can do that:  

```bash
docker build -t garronej/vite-envs-starter:main .

docker run -it -p 8083:80 \ 
    --env TITLE='Title from container env' \ 
    --env MY_META='{ foo: "value1", bar: "value2" }' \ 
    garronej/vite-envs-starter:main
```

Reach http://localhost:8083 to see the result.  


## Config highlights  

Here are listed the configurations that diverges from a vanilla Vite/Docker setup.  

`package.json`
```diff
 "devDependencies": {
+    "vite-envs": "^2.0.0",
 }
```

`vite.config.ts`
```diff
 import { defineConfig } from 'vite'
 import react from '@vitejs/plugin-react'
+import { viteEnvs } from 'vite-envs'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    react(), 
+   viteEnvs()
  ]
})
```

`package.json`
```diff
 "scripts": {
+  "prepare": "vite-envs update-types",
   "dev": "vite",
   "build": "tsc && vite build"
 }
```
`npx vite-envs update-types` updates `src/vite-envs.d.ts` to make TypeScript aware of the 
environment variables you have declared in you `.env` file.  
This script is not strictly required it's just for a better development experience.  

`Dockerfile`
```diff
 # build environment
 FROM node:20-alpine as build
 WORKDIR /app
 COPY package.json yarn.lock .env ./
 RUN yarn install --frozen-lockfile
 COPY . .
 RUN yarn build
 
 # production environment
 FROM nginx:stable-alpine
+RUN apk add --update nodejs npm
 COPY --from=build /app/nginx.conf /etc/nginx/conf.d/default.conf    
 WORKDIR /usr/share/nginx/html
 COPY --from=build /app/dist .
+RUN npm i -g vite-envs@`node -e 'console.log(require("./.vite-envs.json").version)'`
-ENTRYPOINT sh -c "nginx -g 'daemon off;'"
+ENTRYPOINT sh -c "npx vite-envs && nginx -g 'daemon off;'"
```
NOTE: Rest assured that the Docker images generated do **NOT** download `vite-envs` at runtime, only at build time.  
You docker image does not requires an internet connection to start.  
